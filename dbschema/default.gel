module default {

    global backend_url: str {
        default:= "http://localhost:8000";
    }

    global vercel_bypass: str {
        default:= "";
    }

    type Message {
        llm_role: str;
        content: str;
        created_at: datetime {
            default:= datetime_current();
        };

        trigger post_foo after insert, update for each do (
            with 
                endpoint := assert_exists(global backend_url) ++ "/api/agent/foo",
                headers := [
                    ('x-vercel-protection-bypass', assert_exists(global vercel_bypass)),
                    ('Content-Type', 'application/json')
                ],
            select net::http::schedule_request(
                endpoint,
                method := net::http::Method.POST,
                headers := headers,
                body := to_bytes(
                    to_str(
                        json_object_pack(
                            {
                                ("chat_id", <json>__new__.id),
                                ("content", <json>__new__.content),
                                ("llm_role", <json>__new__.llm_role)
                            }
                        )
                    )
                )
            )
        );
    }
}
